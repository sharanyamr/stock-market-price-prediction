import os
import logging
from datetime import datetime, timedelta

from app import app, db
from models import EducationArticle, NewsArticle

def add_sample_education_articles():
    """Add sample educational articles to the database"""
    try:
        # Sample articles
        articles = [
            {
                'title': 'Understanding Stock Market Basics',
                'content': '''## Introduction to Stock Markets

The stock market is a public marketplace where investors can buy and sell shares of companies. When you purchase a stock, you're buying a small ownership stake in a company. As the company grows and becomes more valuable, the value of your shares may increase, allowing you to sell them for a profit. Conversely, if the company performs poorly, the value of your shares may decrease.

## Key Stock Market Concepts

### 1. Stocks and Shares
Stocks (also called equities) represent ownership in a company. Each share of stock is a fractional ownership of the company.

### 2. Bull vs. Bear Markets
A bull market is when stock prices are rising and economic conditions are generally favorable. A bear market is when stock prices are falling, typically by 20% or more from recent highs.

### 3. Dividends
Some companies distribute a portion of their earnings to shareholders as dividends, providing income in addition to potential price appreciation.

### 4. Market Indices
Indices like the S&P 500, Dow Jones Industrial Average, and NASDAQ Composite track the performance of groups of stocks, providing a gauge of overall market performance.

## Getting Started with Investing

1. **Define your goals**: Are you investing for retirement, a major purchase, or another goal?
2. **Assess your risk tolerance**: How comfortable are you with market volatility?
3. **Diversify your portfolio**: Spread investments across different asset classes to manage risk.
4. **Start small**: Begin with an amount you can afford to lose while you learn.
5. **Stay informed**: Keep up with market news and the companies you invest in.

## Common Investment Strategies

- **Buy and Hold**: Purchase stocks and hold them for the long term, regardless of short-term market fluctuations.
- **Dollar-Cost Averaging**: Invest a fixed amount regularly, buying more shares when prices are low and fewer when prices are high.
- **Value Investing**: Look for stocks that appear undervalued based on fundamental analysis.
- **Growth Investing**: Focus on companies with strong growth potential, even if they're currently trading at higher valuations.

Remember, all investments carry risk, and it's important to do thorough research or consult with a financial advisor before investing your money.''',
                'author': 'Financial Education Team',
                'category': 'Fundamentals',
                'featured': True
            },
            {
                'title': 'Technical Analysis: Chart Patterns and Indicators',
                'content': '''## Introduction to Technical Analysis

Technical analysis is a method of evaluating securities by analyzing statistics generated by market activity, such as past prices and volume. Technical analysts do not attempt to measure a security's intrinsic value, but instead use charts and other tools to identify patterns that can suggest future activity.

## Key Chart Patterns

### 1. Head and Shoulders
A head and shoulders pattern is a reversal pattern that signals a trend is likely to move against its previous direction. It consists of three peaks, with the middle peak (the head) being the highest and the two outside peaks (the shoulders) being lower and roughly equal.

### 2. Double Tops and Bottoms
Double tops form after an uptrend when a price reaches a high, pulls back, then reaches a similar high before declining. Double bottoms are the inverse, forming after a downtrend when a price reaches a low, rebounds, then reaches a similar low before rising.

### 3. Cup and Handle
This bullish continuation pattern resembles a cup with a handle. The cup forms after a downtrend as a rounded bottom, and the handle forms as a slight downward drift before the price continues its upward movement.

### 4. Triangles
Triangular patterns can be symmetrical (indicating continuation), ascending (indicating bullish movement), or descending (indicating bearish movement).

## Popular Technical Indicators

### 1. Moving Averages
Moving averages smooth price data to create a single flowing line, making it easier to identify the direction of the trend. Common types include simple moving averages (SMA) and exponential moving averages (EMA).

### 2. Relative Strength Index (RSI)
RSI measures the speed and change of price movements, oscillating between 0 and 100. Traditionally, RSI is considered overbought when above 70 and oversold when below 30.

### 3. Moving Average Convergence Divergence (MACD)
MACD is a trend-following momentum indicator that shows the relationship between two moving averages of a security's price.

### 4. Bollinger Bands
Bollinger Bands consist of a middle band (usually a 20-day SMA) and two outer bands that are standard deviations away from the middle band. They help identify when a price is relatively high or low.

## Limitations of Technical Analysis

- Past performance doesn't guarantee future results
- Patterns and indicators can generate false signals
- External factors (like news events) can override technical indications
- Different analysts may interpret the same chart differently

Technical analysis is most effective when combined with fundamental analysis and used as part of a comprehensive trading strategy.''',
                'author': 'Technical Analysis Expert',
                'category': 'Technical Analysis',
                'featured': True
            },
            {
                'title': 'Fundamental Analysis: Valuing Stocks',
                'content': '''## Introduction to Fundamental Analysis

Fundamental analysis is a method of evaluating a security in an attempt to measure its intrinsic value, by examining related economic, financial, and other qualitative and quantitative factors. The end goal is to determine whether the security is undervalued, overvalued, or fairly priced.

## Key Financial Statements

### 1. Income Statement
The income statement shows a company's revenues, expenses, and profits over a specific period. Key items to analyze include:
- Revenue growth trends
- Gross, operating, and net profit margins
- Earnings per share (EPS)

### 2. Balance Sheet
The balance sheet provides a snapshot of a company's assets, liabilities, and shareholders' equity at a specific point in time. Important areas to examine include:
- Cash and cash equivalents
- Debt levels and debt-to-equity ratio
- Working capital

### 3. Cash Flow Statement
This statement shows how changes in balance sheet accounts and income affect cash and cash equivalents. Pay attention to:
- Operating cash flow
- Free cash flow
- Cash flow trends over time

## Valuation Metrics and Ratios

### 1. Price-to-Earnings (P/E) Ratio
P/E ratio = Market price per share / Earnings per share
This ratio shows how much investors are willing to pay for each dollar of earnings. A high P/E could suggest that a stock is overvalued or that investors expect high growth rates in the future.

### 2. Price-to-Book (P/B) Ratio
P/B ratio = Market price per share / Book value per share
This compares a stock's market value to its book value. A lower P/B ratio could indicate an undervalued stock.

### 3. Dividend Yield
Dividend yield = Annual dividends per share / Price per share
This shows the return on investment for a stock in terms of dividends alone.

### 4. Return on Equity (ROE)
ROE = Net income / Shareholders' equity
ROE measures a company's profitability by revealing how much profit a company generates with the money shareholders have invested.

## Qualitative Factors to Consider

- **Management quality**: Leadership's experience, track record, and vision
- **Competitive advantages**: Brand strength, patents, proprietary technology
- **Industry trends**: Growth potential, regulatory environment, disruption risks
- **Business model**: Scalability, recurring revenue, margin potential

## Fundamental Analysis Process

1. **Industry analysis**: Understand the broader economic and industry context
2. **Company analysis**: Evaluate the business model, competitive position, and growth strategy
3. **Financial analysis**: Examine statements and ratios to assess financial health
4. **Valuation**: Determine an intrinsic value using methods like discounted cash flow analysis
5. **Compare**: Contrast the intrinsic value with the current market price

Remember that fundamental analysis is typically more suited for long-term investing rather than short-term trading.''',
                'author': 'Value Investing Team',
                'category': 'Fundamental Analysis',
                'featured': True
            },
            {
                'title': 'Portfolio Diversification Strategies',
                'content': '''## Why Diversification Matters

Diversification is a risk management strategy that involves spreading investments across various financial instruments, industries, and other categories. It aims to maximize returns by investing in different areas that would each react differently to the same event.

> "Don't put all your eggs in one basket" is the essence of diversification.

## Types of Diversification

### 1. Asset Class Diversification
Spread investments across different asset classes such as:
- Stocks (equities)
- Bonds (fixed income)
- Real estate
- Cash and cash equivalents
- Commodities
- Alternative investments (hedge funds, private equity, etc.)

### 2. Industry/Sector Diversification
Invest across different sectors of the economy to reduce exposure to industry-specific risks:
- Technology
- Healthcare
- Financial services
- Consumer goods
- Energy
- Utilities
- Communications
- Industrial

### 3. Geographic Diversification
Invest in different regions to mitigate country-specific risks:
- Domestic markets
- Developed international markets
- Emerging markets

### 4. Market Capitalization Diversification
Spread investments across companies of different sizes:
- Large-cap (over $10 billion)
- Mid-cap ($2-$10 billion)
- Small-cap ($300 million-$2 billion)
- Micro-cap (under $300 million)

## Building a Diversified Portfolio

### Step 1: Determine Your Asset Allocation
Based on your:
- Investment goals
- Time horizon
- Risk tolerance
- Age and life stage

### Step 2: Select Investments Within Each Asset Class
Choose specific investments that align with your strategy:
- Individual stocks and bonds
- Mutual funds and ETFs
- Index funds
- Real estate investment trusts (REITs)

### Step 3: Regularly Rebalance Your Portfolio
Over time, some investments will perform better than others, causing your portfolio to drift from your target allocation. Periodic rebalancing involves:
- Selling investments that have grown beyond their target allocation
- Buying more of those that have fallen below their target

## Diversification Pitfalls to Avoid

### Over-diversification
Having too many investments can lead to:
- Diminishing returns on diversification benefits
- Higher transaction costs
- Difficulty in monitoring portfolio

### False diversification
Mistakenly believing you're diversified when investments actually move together, such as:
- Owning multiple technology stocks that tend to move in tandem
- Investing in several funds with overlapping holdings

## Measuring Diversification Success

- **Correlation coefficient**: Measures how closely the returns of two investments move together
- **Standard deviation**: Measures the volatility or risk of your portfolio
- **Sharpe ratio**: Measures risk-adjusted returns

Remember, the goal of diversification isn't to maximize returnsâ€”it's to optimize returns for your given level of risk. A properly diversified portfolio should generate more consistent returns over time while reducing overall risk.''',
                'author': 'Risk Management Team',
                'category': 'Portfolio Management',
                'featured': False
            },
            {
                'title': 'Understanding Market Indices and Their Importance',
                'content': '''## What Are Market Indices?

A market index is a hypothetical portfolio of investment holdings that represents a segment of the financial market. The calculation of the index value comes from the prices of the underlying holdings. Some indices track a relatively small subset of the financial market, while others track entire markets.

## Major Global Indices

### United States
- **S&P 500**: Tracks 500 of the largest companies listed on US stock exchanges, weighted by market capitalization
- **Dow Jones Industrial Average (DJIA)**: Price-weighted average of 30 significant stocks traded on the NYSE and NASDAQ
- **NASDAQ Composite**: Includes all companies listed on the NASDAQ stock exchange, heavily weighted toward technology
- **Russell 2000**: Tracks 2,000 small-cap US companies

### International
- **FTSE 100** (UK): Represents 100 companies listed on the London Stock Exchange
- **Nikkei 225** (Japan): Price-weighted index of Japan's top 225 companies
- **DAX** (Germany): Tracks 40 major German companies trading on the Frankfurt Stock Exchange
- **Hang Seng** (Hong Kong): Comprises 50 of the largest companies in Hong Kong
- **SENSEX** (India): Consists of 30 well-established companies listed on the BSE

## How Indices Are Used

### 1. Market Performance Benchmarks
Indices provide a standard against which professional money managers and individual investors can measure their portfolio performance.

### 2. Economic Indicators
Because they track segments of the market, indices can provide insights into economic health. For example, a rising S&P 500 generally suggests a strong US economy.

### 3. Investment Vehicles
Many investment products are based on indices:
- Index funds aim to replicate the performance of a specific index
- Exchange-traded funds (ETFs) often track indices
- Index options and futures allow investors to speculate on or hedge against index movements

## How Indices Are Calculated

There are several methods for calculating index values:

### 1. Price-weighted
Companies with higher stock prices have greater influence on the index (e.g., Dow Jones Industrial Average).

### 2. Market-cap weighted
Companies with larger market capitalizations have greater influence (e.g., S&P 500, NASDAQ Composite).

### 3. Equal-weighted
Each component has the same influence regardless of price or market cap.

### 4. Fundamentally weighted
Components are weighted based on fundamental metrics like revenue, dividends, or earnings.

## Limitations of Market Indices

- They don't represent the entire market
- Methodology can create biases (e.g., market-cap weighting gives more influence to larger companies)
- Index changes (additions and removals) can affect performance
- They don't account for dividends unless specifically designed to do so

## Using Indices in Your Investment Strategy

- **Passive investing**: Investing in index funds to match market returns while minimizing fees
- **Benchmarking**: Comparing your portfolio's performance against relevant indices
- **Asset allocation**: Using different indices to determine exposure to various market segments
- **Market analysis**: Tracking indices to understand market trends and sentiment

Indices provide valuable information to investors, but remember they're just one tool among many for making informed investment decisions.''',
                'author': 'Market Research Department',
                'category': 'Market Fundamentals',
                'featured': False
            }
        ]
        
        # Add articles to database
        added_count = 0
        for article_data in articles:
            # Check if article already exists
            existing = EducationArticle.query.filter_by(title=article_data['title']).first()
            if existing:
                continue
                
            article = EducationArticle(
                title=article_data['title'],
                content=article_data['content'],
                author=article_data['author'],
                category=article_data['category'],
                featured=article_data['featured']
            )
            
            db.session.add(article)
            added_count += 1
            
        db.session.commit()
        logging.info(f"Added {added_count} sample education articles")
        return added_count
        
    except Exception as e:
        db.session.rollback()
        logging.error(f"Error adding sample education articles: {e}")
        return 0

def add_sample_news_articles():
    """Add sample news articles to the database"""
    try:
        current_time = datetime.now()
        sample_articles = [
            {
                'title': 'Markets Rally as Fed Signals Potential Rate Cut',
                'content': 'Stock markets surged today after the Federal Reserve indicated it might consider rate cuts later this year if inflation continues to moderate. The S&P 500 closed up 1.8% while the Nasdaq gained over 2.3%.',
                'source': 'Market News Today',
                'url': 'https://example.com/markets-rally-fed-signals-rate-cut',
                'published_at': (current_time - timedelta(hours=2)),
                'category': 'Markets'
            },
            {
                'title': 'Tech Stocks Lead the Way in Market Rebound',
                'content': 'Technology stocks are leading a market rebound as strong earnings reports from major players suggest the sector remains resilient despite economic uncertainties. Semiconductor stocks particularly outperformed with gains exceeding 3%.',
                'source': 'The Financial Times',
                'url': 'https://example.com/tech-stocks-lead-market-rebound',
                'published_at': (current_time - timedelta(hours=5)),
                'category': 'Technology'
            },
            {
                'title': 'Investor Sentiment Improves as Inflation Data Shows Signs of Cooling',
                'content': 'The latest inflation data showed signs of moderation, improving investor sentiment. Consumer prices rose at a slower pace than expected, potentially giving the Federal Reserve more flexibility in its monetary policy decisions.',
                'source': 'Financial Post',
                'url': 'https://example.com/investor-sentiment-improves-inflation',
                'published_at': (current_time - timedelta(hours=8)),
                'category': 'Economy'
            },
            {
                'title': 'Oil Prices Rise Amid Supply Concerns',
                'content': 'Oil prices climbed today as supply concerns overshadowed demand worries. Brent crude futures rose above $85 per barrel after a major producer announced unexpected maintenance at key facilities.',
                'source': 'Energy News Network',
                'url': 'https://example.com/oil-prices-rise-supply-concerns',
                'published_at': (current_time - timedelta(hours=10)),
                'category': 'Commodities'
            },
            {
                'title': 'Small Cap Stocks Outperform as Economic Outlook Improves',
                'content': 'Small-cap stocks outperformed their larger counterparts today as investors grew more optimistic about economic growth prospects. The Russell 2000 index gained over 2%, outpacing the S&P 500.',
                'source': 'Investor Daily',
                'url': 'https://example.com/small-cap-stocks-outperform',
                'published_at': (current_time - timedelta(hours=12)),
                'category': 'Markets'               
            }
        ]
        
        # Save sample news articles to database
        saved_count = 0
        for article in sample_articles:
            # Check if article already exists
            existing = NewsArticle.query.filter_by(url=article['url']).first()
            if existing:
                continue
                
            # Create new article
            news = NewsArticle(
                title=article['title'],
                content=article['content'],
                source=article['source'],
                url=article['url'],
                published_at=article['published_at'],
                fetched_at=current_time,
                category=article['category']
            )
            
            db.session.add(news)
            saved_count += 1
            
        db.session.commit()
        logging.info(f"Added {saved_count} sample news articles")
        return saved_count
            
    except Exception as e:
        db.session.rollback()
        logging.error(f"Error adding sample news: {e}")
        return 0

# Function to create all sample content
def create_all_sample_content():
    with app.app_context():
        education_count = add_sample_education_articles()
        news_count = add_sample_news_articles()
        
        print(f"Added {education_count} education articles and {news_count} news articles")
        return education_count + news_count
        
if __name__ == "__main__":
    create_all_sample_content()
